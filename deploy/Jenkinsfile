@Library('gtops-sdk@main') _


def BRANCH_NAME = 'simpleproject'


pipeline {
    agent {
        kubernetes {
            cloud 'k3s'
            namespace 'jenkins'
            serviceAccount 'jenkins'
            yamlFile 'deploy/testproject.yaml'
        }
    }
    environment {
        GO_VERSION = '1.24.4'  // go版本
    }

    options {
        timestamps()  
        }

    stages {

        stage('init ') {
            steps{
            string date = new Date().format('yyyy-MM-dd-HH-mm-ss')  // 当前时间戳
            string commitID = sh(returnStdout: true, script: "echo -n ${GIT_COMMIT} | awk '{print substr(\$0,0,8)}'").trim()  // 截取commit前8位
            string imageName = sh(returnStdout: true, script: ''' echo -n $(basename $GIT_URL .git) | sed 's/.*\\///' ''')  // 从Git URL提取项目名，basename 提取最后一段文件名 后边的.git 用于去掉指定的后缀
            string imageTag = BRANCH_NAME + "_" + "_" + date + "_" + commitID  // 组合镜像标签
            string imageRepo = "${imageName}:${imageTag}"  // 完整镜像仓库地址
            string latestImageRepo = "${imageName}_${BRANCH_NAME}:latest"  // latest标签镜像
            string GO_VERSION = env.GO_VERSION
            println "imageTag: ${imageTag} \n imageName: ${imageName}"
            }
            
        }

        stage('Checkout') {
            steps {
                checkout scm
                sh 'echo "Checked out to: $(pwd)" && ls -lah'
            }
        }

        

         stage('build images') {
                    steps {
                        container('kaniko') {
                            echo "Starting Kaniko Build..."
                            sh '''
                            cat /kaniko/.docker/config.json
                            /kaniko/executor \
                            --dockerfile=deploy/Dockerfile \
                            --context=$WORKSPACE \
                            --destination=gtharbor.legoutech.cn/library/simpleproject:${BUILD_NUMBER} \
                            --insecure \
                            --skip-tls-verify \
                            --ignore-path=/sys \
                            --ignore-path=/proc \
                            --ignore-path=/dev  \
                            --ignore-path=/product_uuid
                            '''
                            }
                    }
                }
    }
}
